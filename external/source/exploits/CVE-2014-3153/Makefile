
MUSL_DIR=~/dev/git/mettle/build/tools/musl-cross/bin/
MUSL_PREFIX=$(MUSL_DIR)armv5l-linux-musleabi-
MUSL_CC=$(MUSL_PREFIX)cc

all: install

binary: futex_requeue.c
	$(MUSL_CC) -DFUTEX_MAIN -static -fno-stack-protector -O0 -o $@ $^

elf2shellcode:
	gcc elf2shellcode.c -o elf2shellcode

shellcode: clean binary elf2shellcode
	./elf2shellcode binary binary.bin
	mv binary.bin ../../../../data/exploits/CVE-2014-3153.bin

build:
	ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=./Android.mk APP_ABI=armeabi

install: build
	mv libs/armeabi/libexploit.so ../../../../data/exploits/CVE-2014-3153.so

push: build
	adb push libs/armeabi/debugexploit /data/local/tmp/futex

run: push
	adb shell "/data/local/tmp/futex"

clean:
	rm -rf libs
	rm -rf obj
	rm -rf binary binary.bin elf2shellcode

